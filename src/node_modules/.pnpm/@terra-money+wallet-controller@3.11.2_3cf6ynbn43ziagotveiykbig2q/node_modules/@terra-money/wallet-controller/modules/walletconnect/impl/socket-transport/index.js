import { isBrowser, getLocation, getQueryString, detectEnv, appendToQueryString, } from '@walletconnect/utils';
import NetworkMonitor from './network';
// @ts-ignore
const WS = typeof global.WebSocket !== 'undefined' ? global.WebSocket : require('ws');
// -- SocketTransport ------------------------------------------------------ //
class SocketTransport {
    // -- constructor ----------------------------------------------------- //
    constructor(opts) {
        this.opts = opts;
        this._queue = [];
        this._events = [];
        this._subscriptions = [];
        // -- public ---------------------------------------------------------- //
        this.open = () => {
            this._socketCreate();
        };
        this.close = () => {
            this._socketClose();
        };
        this.send = (message, topic, silent) => {
            if (!topic || typeof topic !== 'string') {
                throw new Error('Missing or invalid topic field');
            }
            this._socketSend({
                topic: topic,
                type: 'pub',
                payload: message,
                silent: !!silent,
            });
        };
        this.subscribe = (topic) => {
            this._socketSend({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            });
        };
        this.on = (event, callback) => {
            this._events.push({ event, callback });
        };
        // -- private ---------------------------------------------------------- //
        this._socketCreate = () => {
            if (this._nextSocket) {
                return;
            }
            const url = getWebSocketUrl(this._url, this._protocol, this._version);
            this._nextSocket = new WS(url);
            if (!this._nextSocket) {
                throw new Error('Failed to create socket');
            }
            this._nextSocket.onmessage = (event) => this._socketReceive(event);
            this._nextSocket.onopen = () => this._socketOpen();
            this._nextSocket.onerror = (event) => this._socketError(event);
            this._nextSocket.onclose = () => {
                this._nextSocket = null;
                setTimeout(this._socketCreate, 500);
            };
        };
        this._socketOpen = () => {
            this._socketClose();
            this._socket = this._nextSocket;
            this._nextSocket = null;
            this._queueSubscriptions();
            this._pushQueue();
        };
        this._socketClose = () => {
            if (this._socket) {
                this._socket.onclose = () => {
                    // empty
                };
                this._socket.close();
            }
        };
        this._socketSend = (socketMessage) => {
            const message = JSON.stringify(socketMessage);
            if (this._socket && this._socket.readyState === 1) {
                this._socket.send(message);
            }
            else {
                this._setToQueue(socketMessage);
                this._socketCreate();
            }
        };
        this._socketReceive = async (event) => {
            let socketMessage;
            try {
                socketMessage = JSON.parse(event.data);
            }
            catch (error) {
                return;
            }
            this._socketSend({
                topic: socketMessage.topic,
                type: 'ack',
                payload: '',
                silent: true,
            });
            if (this._socket && this._socket.readyState === 1) {
                const events = this._events.filter((itemEvent) => itemEvent.event === 'message');
                if (events && events.length) {
                    events.forEach((itemEvent) => itemEvent.callback(socketMessage));
                }
            }
        };
        this._socketError = (e) => {
            const events = this._events.filter((event) => event.event === 'error');
            if (events && events.length) {
                events.forEach((event) => event.callback(e));
            }
        };
        this._queueSubscriptions = () => {
            const subscriptions = this._subscriptions;
            subscriptions.forEach((topic) => this._queue.push({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            }));
            this._subscriptions = this.opts.subscriptions || [];
        };
        this._setToQueue = (socketMessage) => {
            this._queue.push(socketMessage);
        };
        this._pushQueue = () => {
            const queue = this._queue;
            queue.forEach((socketMessage) => this._socketSend(socketMessage));
            this._queue = [];
        };
        this._protocol = opts.protocol;
        this._version = opts.version;
        this._url = '';
        this._netMonitor = null;
        this._socket = null;
        this._nextSocket = null;
        this._subscriptions = opts.subscriptions || [];
        this._netMonitor = opts.netMonitor || new NetworkMonitor();
        if (!opts.url || typeof opts.url !== 'string') {
            throw new Error('Missing or invalid WebSocket url');
        }
        this._url = opts.url;
        this._netMonitor.on('online', () => this._socketCreate());
    }
    set readyState(value) {
        // empty
    }
    get readyState() {
        return this._socket ? this._socket.readyState : -1;
    }
    set connecting(value) {
        // empty
    }
    get connecting() {
        return this.readyState === 0;
    }
    set connected(value) {
        // empty
    }
    get connected() {
        return this.readyState === 1;
    }
    set closing(value) {
        // empty
    }
    get closing() {
        return this.readyState === 2;
    }
    set closed(value) {
        // empty
    }
    get closed() {
        return this.readyState === 3;
    }
}
function getWebSocketUrl(webUrl, protocol, version) {
    var _a, _b;
    const url = webUrl.startsWith('https')
        ? webUrl.replace('https', 'wss')
        : webUrl.startsWith('http')
            ? webUrl.replace('http', 'ws')
            : webUrl;
    const splitUrl = url.split('?');
    const params = isBrowser()
        ? {
            protocol,
            version,
            env: 'browser',
            host: ((_a = getLocation()) === null || _a === void 0 ? void 0 : _a.host) || '',
        }
        : {
            protocol,
            version,
            env: ((_b = detectEnv()) === null || _b === void 0 ? void 0 : _b.name) || '',
        };
    const queryString = appendToQueryString(getQueryString(splitUrl[1] || ''), params);
    return splitUrl[0] + '?' + queryString;
}
export default SocketTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvQHRlcnJhLW1vbmV5L3dhbGxldC1jb250cm9sbGVyL21vZHVsZXMvd2FsbGV0Y29ubmVjdC9pbXBsL3NvY2tldC10cmFuc3BvcnQvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsT0FBTyxFQUNMLFNBQVMsRUFDVCxXQUFXLEVBQ1gsY0FBYyxFQUNkLFNBQVMsRUFDVCxtQkFBbUIsR0FDcEIsTUFBTSxzQkFBc0IsQ0FBQztBQUU5QixPQUFPLGNBQWMsTUFBTSxXQUFXLENBQUM7QUFFdkMsYUFBYTtBQUNiLE1BQU0sRUFBRSxHQUNOLE9BQU8sTUFBTSxDQUFDLFNBQVMsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUU3RSwrRUFBK0U7QUFFL0UsTUFBTSxlQUFlO0lBV25CLDBFQUEwRTtJQUUxRSxZQUFvQixJQUE2QjtRQUE3QixTQUFJLEdBQUosSUFBSSxDQUF5QjtRQU56QyxXQUFNLEdBQXFCLEVBQUUsQ0FBQztRQUM5QixZQUFPLEdBQXNCLEVBQUUsQ0FBQztRQUNoQyxtQkFBYyxHQUFhLEVBQUUsQ0FBQztRQStEdEMsMEVBQTBFO1FBRW5FLFNBQUksR0FBRyxHQUFHLEVBQUU7WUFDakIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQztRQUVLLFVBQUssR0FBRyxHQUFHLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RCLENBQUMsQ0FBQztRQUVLLFNBQUksR0FBRyxDQUFDLE9BQWUsRUFBRSxLQUFjLEVBQUUsTUFBZ0IsRUFBUSxFQUFFO1lBQ3hFLElBQUksQ0FBQyxLQUFLLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO2dCQUN2QyxNQUFNLElBQUksS0FBSyxDQUFD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LEVBQUU7U0FDN0IsQ0FBQztJQUNOLE1BQU0sV0FBVyxHQUFHLG1CQUFtQixDQUNyQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUNqQyxNQUFNLENBQ1AsQ0FBQztJQUNGLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxXQUFXLENBQUM7QUFDekMsQ0FBQztBQUVELGVBQWUsZUFBZSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSVNvY2tldE1lc3NhZ2UsXG4gIElUcmFuc3BvcnRFdmVudCxcbiAgSU5ldHdvcmtNb25pdG9yLFxuICBJVHJhbnNwb3J0TGliLFxuICBJU29ja2V0VHJhbnNwb3J0T3B0aW9ucyxcbn0gZnJvbSAnQHdhbGxldGNvbm5lY3QvdHlwZXMnO1xuaW1wb3J0IHtcbiAgaXNCcm93c2VyLFxuICBnZXRMb2NhdGlvbixcbiAgZ2V0UXVlcnlTdHJpbmcsXG4gIGRldGVjdEVudixcbiAgYXBwZW5kVG9RdWVyeVN0cmluZyxcbn0gZnJvbSAnQHdhbGxldGNvbm5lY3QvdXRpbHMnO1xuXG5pbXBvcnQgTmV0d29ya01vbml0b3IgZnJvbSAnLi9uZXR3b3JrJztcblxuLy8gQHRzLWlnbm9yZVxuY29uc3QgV1MgPVxuICB0eXBlb2YgZ2xvYmFsLldlYlNvY2tldCAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWwuV2ViU29ja2V0IDogcmVxdWlyZSgnd3MnKTtcblxuLy8gLS0gU29ja2V0VHJhbnNwb3J0IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvL1xuXG5jbGFzcyBTb2NrZXRUcmFuc3BvcnQgaW1wbGVtZW50cyBJVHJhbnNwb3J0TGliIHtcbiAgcHJpdmF0ZSBfcHJvdG9jb2w6IHN0cmluZztcbiAgcHJpdmF0ZSBfdmVyc2lvbjogbnVtYmVyO1xuICBwcml2YXRlIF91cmw6IHN0cmluZztcbiAgcHJpdmF0ZSBfbmV0TW9uaXRvcjogSU5ldHdvcmtNb25pdG9yIHwgbnVsbDtcbiAgcHJpdmF0ZSBfc29ja2V0OiBXZWJTb2NrZXQgfCBudWxsO1xuICBwcml2YXRlIF9uZXh0U29ja2V0OiBXZWJTb2NrZXQgfCBudWxsO1xuICBwcml2YXRlIF9xdWV1ZTogSVNvY2tldE1lc3NhZ2VbXSA9IFtdO1xuICBwcml2YXRlIF9ldmVudHM6IElUcmFuc3BvcnRFdmVudFtdID0gW107XG4gIHByaXZhdGUgX3N1YnNjcmlwdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgLy8gLS0gY29uc3RydWN0b3IgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy9cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdHM6IElTb2NrZXRUcmFuc3BvcnRPcHRpb25zKSB7XG4gICAgdGhpcy5fcHJvdG9jb2wgPSBvcHRzLnByb3RvY29sO1xuICAgIHRoaXMuX3ZlcnNpb24gPSBvcHRzLnZlcnNpb247XG4gICAgdGhpcy5fdXJsID0gJyc7XG4gICAgdGhpcy5fbmV0TW9uaXRvciA9IG51bGw7XG4gICAgdGhpcy5fc29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLl9uZXh0U29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0gb3B0cy5zdWJzY3JpcHRpb25zIHx8IFtdO1xuICAgIHRoaXMuX25ldE1vbml0b3IgPSBvcHRzLm5ldE1vbml0b3IgfHwgbmV3IE5ldHdvcmtNb25pdG9yKCk7XG5cbiAgICBpZiAoIW9wdHMudXJsIHx8IHR5cGVvZiBvcHRzLnVybCAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBvciBpbnZhbGlkIFdlYlNvY2tldCB1cmwnKTtcbiAgICB9XG5cbiAgICB0aGlzLl91cmwgPSBvcHRzLnVybDtcblxuICAgIHRoaXMuX25ldE1vbml0b3Iub24oJ29ubGluZScsICgpID0+IHRoaXMuX3NvY2tldENyZWF0ZSgpKTtcbiAgfVxuXG4gIHNldCByZWFkeVN0YXRlKHZhbHVlKSB7XG4gICAgLy8gZW1wdHlcbiAgfVxuXG4gIGdldCByZWFkeVN0YXRlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3NvY2tldCA/IHRoaXMuX3NvY2tldC5yZWFkeVN0YXRlIDogLTE7XG4gIH1cblxuICBzZXQgY29ubmVjdGluZyh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY29ubmVjdGluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeVN0YXRlID09PSAwO1xuICB9XG5cbiAgc2V0IGNvbm5lY3RlZCh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY29ubmVjdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJlYWR5U3RhdGUgPT09IDE7XG4gIH1cblxuICBzZXQgY2xvc2luZyh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY2xvc2luZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5yZWFkeVN0YXRlID09PSAyO1xuICB9XG5cbiAgc2V0IGNsb3NlZCh2YWx1ZSkge1xuICAgIC8vIGVtcHR5XG4gIH1cblxuICBnZXQgY2xvc2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJlYWR5U3RhdGUgPT09IDM7XG4gIH1cblxuICAvLyAtLSBwdWJsaWMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvL1xuXG4gIHB1YmxpYyBvcGVuID0gKCkgPT4ge1xuICAgIHRoaXMuX3NvY2tldENyZWF0ZSgpO1xuICB9O1xuXG4gIHB1YmxpYyBjbG9zZSA9ICgpID0+IHtcbiAgICB0aGlzLl9zb2NrZXRDbG9zZSgpO1xuICB9O1xuXG4gIHB1YmxpYyBzZW5kID0gKG1lc3NhZ2U6IHN0cmluZywgdG9waWM/OiBzdHJpbmcsIHNpbGVudD86IGJvb2xlYW4pOiB2b2lkID0+IHtcbiAgICBpZiAoIXRvcGljIHx8IHR5cGVvZiB0b3BpYyAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBvciBpbnZhbGlkIHRvcGljIGZpZWxkJyk7XG4gICAgfVxuXG4gICAgdGhpcy5fc29ja2V0U2VuZCh7XG4gICAgICB0b3BpYzogdG9waWMsXG4gICAgICB0eXBlOiAncHViJyxcbiAgICAgIHBheWxvYWQ6IG1lc3NhZ2UsXG4gICAgICBzaWxlbnQ6ICEhc2lsZW50LFxuICAgIH0pO1xuICB9O1xuXG4gIHB1YmxpYyBzdWJzY3JpYmUgPSAodG9waWM6IHN0cmluZykgPT4ge1xuICAgIHRoaXMuX3NvY2tldFNlbmQoe1xuICAgICAgdG9waWM6IHRvcGljLFxuICAgICAgdHlwZTogJ3N1YicsXG4gICAgICBwYXlsb2FkOiAnJyxcbiAgICAgIHNpbGVudDogdHJ1ZSxcbiAgICB9KTtcbiAgfTtcblxuICBwdWJsaWMgb24gPSAoZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6IChwYXlsb2FkOiBhbnkpID0+IHZvaWQpID0+IHtcbiAgICB0aGlzLl9ldmVudHMucHVzaCh7IGV2ZW50LCBjYWxsYmFjayB9KTtcbiAgfTtcblxuICAvLyAtLSBwcml2YXRlIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gLy9cblxuICBwcml2YXRlIF9zb2NrZXRDcmVhdGUgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuX25leHRTb2NrZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB1cmwgPSBnZXRXZWJTb2NrZXRVcmwodGhpcy5fdXJsLCB0aGlzLl9wcm90b2NvbCwgdGhpcy5fdmVyc2lvbik7XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0ID0gbmV3IFdTKHVybCk7XG5cbiAgICBpZiAoIXRoaXMuX25leHRTb2NrZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGNyZWF0ZSBzb2NrZXQnKTtcbiAgICB9XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0Lm9ubWVzc2FnZSA9IChldmVudDogTWVzc2FnZUV2ZW50KSA9PlxuICAgICAgdGhpcy5fc29ja2V0UmVjZWl2ZShldmVudCk7XG5cbiAgICB0aGlzLl9uZXh0U29ja2V0Lm9ub3BlbiA9ICgpID0+IHRoaXMuX3NvY2tldE9wZW4oKTtcblxuICAgIHRoaXMuX25leHRTb2NrZXQub25lcnJvciA9IChldmVudDogRXZlbnQpID0+IHRoaXMuX3NvY2tldEVycm9yKGV2ZW50KTtcblxuICAgIHRoaXMuX25leHRTb2NrZXQub25jbG9zZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuX25leHRTb2NrZXQgPSBudWxsO1xuICAgICAgc2V0VGltZW91dCh0aGlzLl9zb2NrZXRDcmVhdGUsIDUwMCk7XG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIF9zb2NrZXRPcGVuID0gKCkgPT4ge1xuICAgIHRoaXMuX3NvY2tldENsb3NlKCk7XG4gICAgdGhpcy5fc29ja2V0ID0gdGhpcy5fbmV4dFNvY2tldDtcbiAgICB0aGlzLl9uZXh0U29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLl9xdWV1ZVN1YnNjcmlwdGlvbnMoKTtcbiAgICB0aGlzLl9wdXNoUXVldWUoKTtcbiAgfTtcblxuICBwcml2YXRlIF9zb2NrZXRDbG9zZSA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5fc29ja2V0KSB7XG4gICAgICB0aGlzLl9zb2NrZXQub25jbG9zZSA9ICgpID0+IHtcbiAgICAgICAgLy8gZW1wdHlcbiAgICAgIH07XG4gICAgICB0aGlzLl9zb2NrZXQuY2xvc2UoKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0U2VuZCA9IChzb2NrZXRNZXNzYWdlOiBJU29ja2V0TWVzc2FnZSkgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2U6IHN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHNvY2tldE1lc3NhZ2UpO1xuXG4gICAgaWYgKHRoaXMuX3NvY2tldCAmJiB0aGlzLl9zb2NrZXQucmVhZHlTdGF0ZSA9PT0gMSkge1xuICAgICAgdGhpcy5fc29ja2V0LnNlbmQobWVzc2FnZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3NldFRvUXVldWUoc29ja2V0TWVzc2FnZSk7XG4gICAgICB0aGlzLl9zb2NrZXRDcmVhdGUoKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0UmVjZWl2ZSA9IGFzeW5jIChldmVudDogTWVzc2FnZUV2ZW50KSA9PiB7XG4gICAgbGV0IHNvY2tldE1lc3NhZ2U6IElTb2NrZXRNZXNzYWdlO1xuXG4gICAgdHJ5IHtcbiAgICAgIHNvY2tldE1lc3NhZ2UgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fc29ja2V0U2VuZCh7XG4gICAgICB0b3BpYzogc29ja2V0TWVzc2FnZS50b3BpYyxcbiAgICAgIHR5cGU6ICdhY2snLFxuICAgICAgcGF5bG9hZDogJycsXG4gICAgICBzaWxlbnQ6IHRydWUsXG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5fc29ja2V0ICYmIHRoaXMuX3NvY2tldC5yZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICBjb25zdCBldmVudHMgPSB0aGlzLl9ldmVudHMuZmlsdGVyKFxuICAgICAgICAoaXRlbUV2ZW50KSA9PiBpdGVtRXZlbnQuZXZlbnQgPT09ICdtZXNzYWdlJyxcbiAgICAgICk7XG4gICAgICBpZiAoZXZlbnRzICYmIGV2ZW50cy5sZW5ndGgpIHtcbiAgICAgICAgZXZlbnRzLmZvckVhY2goKGl0ZW1FdmVudCkgPT4gaXRlbUV2ZW50LmNhbGxiYWNrKHNvY2tldE1lc3NhZ2UpKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfc29ja2V0RXJyb3IgPSAoZTogRXZlbnQpID0+IHtcbiAgICBjb25zdCBldmVudHMgPSB0aGlzLl9ldmVudHMuZmlsdGVyKChldmVudCkgPT4gZXZlbnQuZXZlbnQgPT09ICdlcnJvcicpO1xuICAgIGlmIChldmVudHMgJiYgZXZlbnRzLmxlbmd0aCkge1xuICAgICAgZXZlbnRzLmZvckVhY2goKGV2ZW50KSA9PiBldmVudC5jYWxsYmFjayhlKSk7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgX3F1ZXVlU3Vic2NyaXB0aW9ucyA9ICgpID0+IHtcbiAgICBjb25zdCBzdWJzY3JpcHRpb25zID0gdGhpcy5fc3Vic2NyaXB0aW9ucztcblxuICAgIHN1YnNjcmlwdGlvbnMuZm9yRWFjaCgodG9waWM6IHN0cmluZykgPT5cbiAgICAgIHRoaXMuX3F1ZXVlLnB1c2goe1xuICAgICAgICB0b3BpYzogdG9waWMsXG4gICAgICAgIHR5cGU6ICdzdWInLFxuICAgICAgICBwYXlsb2FkOiAnJyxcbiAgICAgICAgc2lsZW50OiB0cnVlLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB0aGlzLm9wdHMuc3Vic2NyaXB0aW9ucyB8fCBbXTtcbiAgfTtcblxuICBwcml2YXRlIF9zZXRUb1F1ZXVlID0gKHNvY2tldE1lc3NhZ2U6IElTb2NrZXRNZXNzYWdlKSA9PiB7XG4gICAgdGhpcy5fcXVldWUucHVzaChzb2NrZXRNZXNzYWdlKTtcbiAgfTtcblxuICBwcml2YXRlIF9wdXNoUXVldWUgPSAoKSA9PiB7XG4gICAgY29uc3QgcXVldWUgPSB0aGlzLl9xdWV1ZTtcblxuICAgIHF1ZXVlLmZvckVhY2goKHNvY2tldE1lc3NhZ2U6IElTb2NrZXRNZXNzYWdlKSA9PlxuICAgICAgdGhpcy5fc29ja2V0U2VuZChzb2NrZXRNZXNzYWdlKSxcbiAgICApO1xuXG4gICAgdGhpcy5fcXVldWUgPSBbXTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0V2ViU29ja2V0VXJsKFxuICB3ZWJVcmw6IHN0cmluZyxcbiAgcHJvdG9jb2w6IHN0cmluZyxcbiAgdmVyc2lvbjogbnVtYmVyLFxuKTogc3RyaW5nIHtcbiAgY29uc3QgdXJsID0gd2ViVXJsLnN0YXJ0c1dpdGgoJ2h0dHBzJylcbiAgICA/IHdlYlVybC5yZXBsYWNlKCdodHRwcycsICd3c3MnKVxuICAgIDogd2ViVXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKVxuICAgID8gd2ViVXJsLnJlcGxhY2UoJ2h0dHAnLCAnd3MnKVxuICAgIDogd2ViVXJsO1xuICBjb25zdCBzcGxpdFVybCA9IHVybC5zcGxpdCgnPycpO1xuICBjb25zdCBwYXJhbXMgPSBpc0Jyb3dzZXIoKVxuICAgID8ge1xuICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgdmVyc2lvbixcbiAgICAgICAgZW52OiAnYnJvd3NlcicsXG4gICAgICAgIGhvc3Q6IGdldExvY2F0aW9uKCk/Lmhvc3QgfHwgJycsXG4gICAgICB9XG4gICAgOiB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICBlbnY6IGRldGVjdEVudigpPy5uYW1lIHx8ICcnLFxuICAgICAgfTtcbiAgY29uc3QgcXVlcnlTdHJpbmcgPSBhcHBlbmRUb1F1ZXJ5U3RyaW5nKFxuICAgIGdldFF1ZXJ5U3RyaW5nKHNwbGl0VXJsWzFdIHx8ICcnKSxcbiAgICBwYXJhbXMsXG4gICk7XG4gIHJldHVybiBzcGxpdFVybFswXSArICc/JyArIHF1ZXJ5U3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBTb2NrZXRUcmFuc3BvcnQ7XG4iXX0=