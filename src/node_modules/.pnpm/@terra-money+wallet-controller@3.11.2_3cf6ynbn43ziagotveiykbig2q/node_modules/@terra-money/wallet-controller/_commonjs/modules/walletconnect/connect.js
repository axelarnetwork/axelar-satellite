"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.connect = exports.connectIfSessionExists = void 0;
const core_1 = __importDefault(require("@walletconnect/core"));
const cryptoLib = __importStar(require("@walletconnect/iso-crypto"));
const utils_1 = require("@walletconnect/utils");
const rxjs_1 = require("rxjs");
const browser_check_1 = require("../../utils/browser-check");
const errors_1 = require("./errors");
const socket_transport_1 = __importDefault(require("./impl/socket-transport"));
const modal_1 = require("./modal");
const types_1 = require("./types");
const WALLETCONNECT_STORAGE_KEY = 'walletconnect';
function connectIfSessionExists(options = {}) {
    const storedSession = localStorage.getItem(WALLETCONNECT_STORAGE_KEY);
    if (typeof storedSession === 'string') {
        return connect(options, true);
    }
    return null;
}
exports.connectIfSessionExists = connectIfSessionExists;
function connect(options = {}, useCachedSession = false) {
    var _a, _b;
    let connector = null;
    let sessionSubject = new rxjs_1.BehaviorSubject({
        status: types_1.WalletConnectSessionStatus.DISCONNECTED,
    });
    const qrcodeModal = (_b = (_a = options.connectorOpts) === null || _a === void 0 ? void 0 : _a.qrcodeModal) !== null && _b !== void 0 ? _b : new modal_1.TerraWalletconnectQrcodeModal();
    const connectorOpts = {
        bridge: 'https://walletconnect.terra.dev/',
        qrcodeModal,
        ...options.connectorOpts,
    };
    const pushServerOpts = options.pushServerOpts;
    // ---------------------------------------------
    // event listeners
    // ---------------------------------------------
    function initEvents() {
        if (!connector) {
            throw new Error(`WalletConnect is not defined!`);
        }
        connector.on('session_update', async (error, payload) => {
            if (error)
                throw error;
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.CONNECTED,
                peerMeta: payload.params[0],
                terraAddress: payload.params[0].accounts[0],
                chainId: payload.params[0].chainId,
            });
            console.log('WALLETCONNECT SESSION UPDATED:', payload.params[0]);
        });
        connector.on('connect', (error, payload) => {
            if (error)
                throw error;
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.CONNECTED,
                peerMeta: payload.params[0],
                terraAddress: payload.params[0].accounts[0],
                chainId: payload.params[0].chainId,
            });
        });
        connector.on('disconnect', (error, payload) => {
            if (error)
                throw error;
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.DISCONNECTED,
            });
        });
    }
    // ---------------------------------------------
    // initialize
    // ---------------------------------------------
    const cachedSession = localStorage.getItem('walletconnect');
    if (typeof cachedSession === 'string' && useCachedSession) {
        const cachedSessionObject = JSON.parse(cachedSession);
        const clientId = cachedSessionObject.clientId;
        const draftConnector = new core_1.default({
            connectorOpts: {
                ...connectorOpts,
                session: JSON.parse(cachedSession),
            },
            pushServerOpts,
            cryptoLib,
            transport: new socket_transport_1.default({
                protocol: 'wc',
                version: 1,
                url: connectorOpts.bridge,
                subscriptions: [clientId],
            }),
        });
        draftConnector.clientId = clientId;
        connector = draftConnector;
        initEvents();
        sessionSubject.next({
            status: types_1.WalletConnectSessionStatus.CONNECTED,
            peerMeta: draftConnector.peerMeta,
            terraAddress: draftConnector.accounts[0],
            chainId: draftConnector.chainId,
        });
    }
    else {
        const clientId = (0, utils_1.uuid)();
        const draftConnector = new core_1.default({
            connectorOpts,
            pushServerOpts,
            cryptoLib,
            transport: new socket_transport_1.default({
                protocol: 'wc',
                version: 1,
                url: connectorOpts.bridge,
                subscriptions: [clientId],
            }),
        });
        draftConnector.clientId = clientId;
        connector = draftConnector;
        if (!draftConnector.connected) {
            draftConnector.createSession().catch(console.error);
            if (qrcodeModal instanceof modal_1.TerraWalletconnectQrcodeModal) {
                qrcodeModal.setCloseCallback(() => {
                    sessionSubject.next({
                        status: types_1.WalletConnectSessionStatus.DISCONNECTED,
                    });
                });
            }
            initEvents();
            sessionSubject.next({
                status: types_1.WalletConnectSessionStatus.REQUESTED,
            });
        }
    }
    // ---------------------------------------------
    // methods
    // ---------------------------------------------
    function disconnect() {
        if (connector && connector.connected) {
            try {
                connector.killSession();
            }
            catch (_a) { }
        }
        sessionSubject.next({
            status: types_1.WalletConnectSessionStatus.DISCONNECTED,
        });
    }
    function session() {
        return sessionSubject.asObservable();
    }
    function getLatestSession() {
        return sessionSubject.getValue();
    }
    /**
     * post transaction
     *
     * @param tx transaction data
     * @throws { WalletConnectUserDenied }
     * @throws { WalletConnectCreateTxFailed }
     * @throws { WalletConnectTxFailed }
     * @throws { WalletConnectTimeout }
     * @throws { WalletConnectTxUnspecifiedError }
     */
    function post(tx) {
        var _a, _b, _c;
        if (!connector || !connector.connected) {
            throw new Error(`WalletConnect is not connected!`);
        }
        const id = Date.now();
        const serializedTxOptions = {
            msgs: tx.msgs.map((msg) => msg.toJSON(tx.isClassic)),
            fee: (_a = tx.fee) === null || _a === void 0 ? void 0 : _a.toJSON(tx.isClassic),
            memo: tx.memo,
            gas: tx.gas,
            gasPrices: (_b = tx.gasPrices) === null || _b === void 0 ? void 0 : _b.toString(),
            gasAdjustment: (_c = tx.gasAdjustment) === null || _c === void 0 ? void 0 : _c.toString(),
            //account_number: tx.account_number,
            //sequence: tx.sequence,
            feeDenoms: tx.feeDenoms,
            timeoutHeight: tx.timeoutHeight,
        };
        if ((0, browser_check_1.isMobile)()) {
            const payload = btoa(JSON.stringify({
                id,
                handshakeTopic: connector.handshakeTopic,
                method: 'post',
                params: serializedTxOptions,
            }));
            // FIXME changed walletconnect confirm schema
            window.location.href = `terrastation://walletconnect_confirm/?action=walletconnect_confirm&payload=${payload}`;
            //window.location.href = `terrastation://wallet_connect_confirm?id=${id}&handshakeTopic=${
            //  connector.handshakeTopic
            //}&params=${JSON.stringify([serializedTxOptions])}`;
        }
        return connector
            .sendCustomRequest({
            id,
            method: 'post',
            params: [serializedTxOptions],
        })
            .catch((error) => {
            let throwError = error;
            try {
                const { code, txhash, message, raw_message } = JSON.parse(error.message);
                switch (code) {
                    case 1:
                        throwError = new errors_1.WalletConnectUserDenied();
                        break;
                    case 2:
                        throwError = new errors_1.WalletConnectCreateTxFailed(message);
                        break;
                    case 3:
                        throwError = new errors_1.WalletConnectTxFailed(txhash, message, raw_message);
                        break;
                    case 4:
                        throwError = new errors_1.WalletConnectTimeout(message);
                        break;
                    case 99:
                        throwError = new errors_1.WalletConnectTxUnspecifiedError(message);
                        break;
                }
            }
            catch (_a) {
                throwError = new errors_1.WalletConnectTxUnspecifiedError(error.message);
            }
            throw throwError;
        });
    }
    /**
     * signBytes transaction
     *
     * @param bytes: Buffer
     * @throws { WalletConnectUserDenied }
     * @throws { WalletConnectTimeout }
     * @throws { WalletConnectSignBytesUnspecifiedError }
     */
    function signBytes(bytes) {
        if (!connector || !connector.connected) {
            throw new Error(`WalletConnect is not connected!`);
        }
        const id = Date.now();
        if ((0, browser_check_1.isMobile)()) {
            const payload = btoa(JSON.stringify({
                id,
                handshakeTopic: connector.handshakeTopic,
                method: 'signBytes',
                params: bytes,
            }));
            window.location.href = `terrastation://walletconnect_confirm/?action=walletconnect_confirm&payload=${payload}`;
        }
        return connector
            .sendCustomRequest({
            id,
            method: 'signBytes',
            params: [bytes],
        })
            .catch((error) => {
            let throwError = error;
            try {
                const { code, message } = JSON.parse(error.message);
                switch (code) {
                    case 1:
                        throwError = new errors_1.WalletConnectUserDenied();
                        break;
                    case 4:
                        throwError = new errors_1.WalletConnectTimeout(message);
                        break;
                    case 99:
                        throwError = new errors_1.WalletConnectSignBytesUnspecifiedError(message);
                        break;
                }
            }
            catch (_a) {
                throwError = new errors_1.WalletConnectSignBytesUnspecifiedError(error.message);
            }
            throw throwError;
        });
    }
    // ---------------------------------------------
    // return
    // ---------------------------------------------
    return {
        session,
        getLatestSession,
        post,
        signBytes,
        disconnect,
    };
}
exports.connect = connect;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9AdGVycmEtbW9uZXkvd2FsbGV0LWNvbnRyb2xsZXIvbW9kdWxlcy93YWxsZXRjb25uZWN0L2Nvbm5lY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNBLCtEQUE0QztBQUM1QyxxRUFBdUQ7QUFLdkQsZ0RBQTRDO0FBQzVDLCtCQUFtRDtBQUNuRCw2REFBcUQ7QUFDckQscUNBT2tCO0FBQ2xCLCtFQUFzRDtBQUN0RCxtQ0FBd0Q7QUFDeEQsbUNBSWlCO0FBbUNqQixNQUFNLHlCQUF5QixHQUFHLGVBQWUsQ0FBQztBQUVsRCxTQUFnQixzQkFBc0IsQ0FDcEMsVUFBMEMsRUFBRTtJQUU1QyxNQUFNLGFBQWEsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFFdEUsSUFBSSxPQUFPLGFBQWEsS0FBSyxRQUFRLEVBQUU7UUFDckMsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQy9CO0lBRUQsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBVkQsd0RBVUM7QUFFRCxTQUFnQixPQUFPLENBQ3JCLFVBQTBDLEVBQUUsRUFDNUMsbUJBQTRCLEtBQUs7O0lBRWpDLElBQUksU0FBUyxHQUFxQixJQUFJLENBQUM7SUFFdkMsSUFBSSxjQUFjLEdBQ2hCLElBQUksc0JBQWUsQ0FBdUI7UUFDeEMsTUFBTSxFQUFFLGtDQUEwQixDQUFDLFlBQVk7S0FDaEQsQ0FBQyxDQUFDO0lBRUwsTUFBTSxXQUFXLEdBQ2YsTUFBQSxNQUFBLE9BQU8sQ0FBQyxhQUFhLDBDQUFFLFdBQVcsbUNBQUksSUFBSSxxQ0FBNkIsRUFBRSxDQUFDO0lBRTVFLE1BQU0sYUFBYSxHQUEwQjtRQUMzQyxNQUFNLEVBQUUsa0NBQWtDO1FBQzFDLFdBQVc7UUFDWCxHQUFHLE9BQU8sQ0FBQyxhQUFhO0tBQ3pCLENBQUM7SUFFRixNQUFNLGNBQWMsR0FBbUMsT0FBTyxDQUFDLGNBQWMsQ0FBQztJQUU5RSxnREFBZ0Q7SUFDaEQsa0JBQWtCO0lBQ2xCLGdEQUFnRDtJQUNoRCxTQUFTLFVBQVU7UUFDakIsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztTQUNsRDtRQUVELFNBQVMsQ0FBQyxFQUFFLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUN0RCxJQUFJLEtBQUs7Z0JBQUUsTUFBTSxLQUFLLENBQUM7WUFFdkIsY0FBYyxDQUFDLElBQUksQ0FBQztnQkFDbEIsTUFBTSxFQUFFLGtDQUEwQixDQUFDLFNBQVM7Z0JBQzVDLFFBQVEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDM0IsWUFBWSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDM0MsT0FBTyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTzthQUNuQyxDQUFDLENBQUM7WUFFSCxPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuRSxDQUFDLENBQUMsQ0FBQztRQUVILFNBQVMsQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFO1lBQ3pDLElBQUksS0FBSztnQkFBRSxNQUFNLEtBQUssQ0FBQztZQUV2QixjQUFjLENBQUMsSUFBSSxDQUFDO2dCQUNsQixNQUFNLEVBQUUsa0NBQTBCLENBQUMsU0FBUztnQkFDNUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUMzQixZQUFZLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUMzQyxPQUFPLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPO2FBQ25DLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsU0FBUyxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDNUMsSUFBSSxLQUFLO2dCQUFFLE1BQU0sS0FBSyxDQUFDO1lBRXZCLGNBQWMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2xCLE1BQU0sRUFBRSxrQ0FBMEIsQ0FBQyxZQUFZO2FBQ2hELENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGdEQUFnRDtJQUNoRCxhQUFhO0lBQ2IsZ0RBQWdEO0lBQ2hELE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7SUFFNUQsSUFBSSxPQUFPLGFBQWEsS0FBSyxRQUFRLElBQUksZ0JBQWdCLEVBQUU7UUFDekQsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLFFBQVEsQ0FBQztRQUM5QyxNQUFNLGNBQWMsR0FBRyxJQUFJLGNBQVMsQ0FBQztZQUNuQyxhQUFhLEVBQUU7Z0JBQ2IsR0FBRyxhQUFhO2dCQUNoQixPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUM7YUFDbkM7WUFDRCxjQUFjO1lBQ2QsU0FBUztZQUNULFNBQVMsRUFBRSxJQUFJLDBCQUFlLENBQUM7Z0JBQzdCLFFBQVEsRUFBRSxJQUFJO2dCQUNkLE9BQU8sRUFBRSxDQUFDO2dCQUNWLEdBQUcsRUFBRSxhQUFhLENBQUMsTUFBTztnQkFDMUIsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDO2FBQzFCLENBQUM7U0FDSCxDQUFDLENBQUM7UUFDSCxjQUFjLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUVuQyxTQUFTLEdBQUcsY0FBYyxDQUFDO1FBRTNCLFVBQVUsRUFBRSxDQUFDO1FBRWIsY0FBYyxDQUFDLElBQUksQ0FBQztZQUNsQixNQUFNLEVBQUUsa0NBQTBCLENBQUMsU0FBUztZQUM1QyxRQUFRLEVBQUUsY0FBYyxDQUFDLFFBQVM7WUFDbEMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ3hDLE9BQU8sRUFBRSxjQUFjLENBQUMsT0FBTztTQUNoQyxDQUFDLENBQUM7S0FDSjtTQUFNO1FBQ0wsTUFBTSxRQUFRLEdBQUcsSUFBQSxZQUFJLEdBQUUsQ0FBQztRQUN4QixNQUFNLGNBQWMsR0FBRyxJQUFJLGNBQVMsQ0FBQztZQUNuQyxhQUFhO1lBQ2IsY0FBYztZQUNkLFNBQVM7WUFDVCxTQUFTLEVBQUUsSUFBSSwwQkFBZSxDQUFDO2dCQUM3QixRQUFRLEVBQUUsSUFBSTtnQkFDZCxPQUFPLEVBQUUsQ0FBQztnQkFDVixHQUFHLEVBQUUsYUFBYSxDQUFDLE1BQU87Z0JBQzFCLGFBQWEsRUFBRSxDQUFDLFFBQVEsQ0FBQzthQUMxQixDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBQ0gsY0FBYyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFFbkMsU0FBUyxHQUFHLGNBQWMsQ0FBQztRQUUzQixJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsRUFBRTtZQUM3QixjQUFjLENBQUMsYUFBYSxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVwRCxJQUFJLFdBQVcsWUFBWSxxQ0FBNkIsRUFBRTtnQkFDeEQsV0FBVyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRTtvQkFDaEMsY0FBYyxDQUFDLElBQUksQ0FBQzt3QkFDbEIsTUFBTSxFQUFFLGtDQUEwQixDQUFDLFlBQVk7cUJBQ2hELENBQUMsQ0FBQztnQkFDTCxDQUFDLENBQUMsQ0FBQzthQUNKO1lBRUQsVUFBVSxFQUFFLENBQUM7WUFFYixjQUFjLENBQUMsSUFBSSxDQUFDO2dCQUNsQixNQUFNLEVBQUUsa0NBQTBCLENBQUMsU0FBUzthQUM3QyxDQUFDLENBQUM7U0FDSjtLQUNGO0lBRUQsZ0RBQWdEO0lBQ2hELFVBQVU7SUFDVixnREFBZ0Q7SUFDaEQsU0FBUyxVQUFVO1FBQ2pCLElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxTQUFTLEVBQUU7WUFDcEMsSUFBSTtnQkFDRixTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDekI7WUFBQyxXQUFNLEdBQUU7U0FDWDtRQUVELGNBQWMsQ0FBQyxJQUFJLENBQUM7WUFDbEIsTUFBTSxFQUFFLGtDQUEwQixDQUFDLFlBQVk7U0FDaEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFNBQVMsT0FBTztRQUNkLE9BQU8sY0FBYyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxTQUFTLGdCQUFnQjtRQUN2QixPQUFPLGNBQWMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7Ozs7Ozs7OztPQVNHO0lBQ0gsU0FBUyxJQUFJLENBQUMsRUFBb0I7O1FBQ2hDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFO1lBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQztTQUNwRDtRQUVELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUV0QixNQUFNLG1CQUFtQixHQUFHO1lBQzFCLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDcEQsR0FBRyxFQUFFLE1BQUEsRUFBRSxDQUFDLEdBQUcsMENBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUM7WUFDakMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJO1lBQ2IsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHO1lBQ1gsU0FBUyxFQUFFLE1BQUEsRUFBRSxDQUFDLFNBQVMsMENBQUUsUUFBUSxFQUFFO1lBQ25DLGFBQWEsRUFBRSxNQUFBLEVBQUUsQ0FBQyxhQUFhLDBDQUFFLFFBQVEsRUFBRTtZQUMzQyxvQ0FBb0M7WUFDcEMsd0JBQXdCO1lBQ3hCLFNBQVMsRUFBRSxFQUFFLENBQUMsU0FBUztZQUN2QixhQUFhLEVBQUUsRUFBRSxDQUFDLGFBQWE7U0FDaEMsQ0FBQztRQUVGLElBQUksSUFBQSx3QkFBUSxHQUFFLEVBQUU7WUFDZCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ2IsRUFBRTtnQkFDRixjQUFjLEVBQUUsU0FBUyxDQUFDLGNBQWM7Z0JBQ3hDLE1BQU0sRUFBRSxNQUFNO2dCQUNkLE1BQU0sRUFBRSxtQkFBbUI7YUFDNUIsQ0FBQyxDQUNILENBQUM7WUFFRiw2Q0FBNkM7WUFDN0MsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsOEVBQThFLE9BQU8sRUFBRSxDQUFDO1lBQy9HLDBGQUEwRjtZQUMxRiw0QkFBNEI7WUFDNUIscURBQXFEO1NBQ3REO1FBRUQsT0FBTyxTQUFTO2FBQ2IsaUJBQWlCLENBQUM7WUFDakIsRUFBRTtZQUNGLE1BQU0sRUFBRSxNQUFNO1lBQ2QsTUFBTSxFQUFFLENBQUMsbUJBQW1CLENBQUM7U0FDOUIsQ0FBQzthQUNELEtBQUssQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ2YsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBRXZCLElBQUk7Z0JBQ0YsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQ3ZELEtBQUssQ0FBQyxPQUFPLENBQ2QsQ0FBQztnQkFDRixRQUFRLElBQUksRUFBRTtvQkFDWixLQUFLLENBQUM7d0JBQ0osVUFBVSxHQUFHLElBQUksZ0NBQXVCLEVBQUUsQ0FBQzt3QkFDM0MsTUFBTTtvQkFDUixLQUFLLENBQUM7d0JBQ0osVUFBVSxHQUFHLElBQUksb0NBQTJCLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ3RELE1BQU07b0JBQ1IsS0FBSyxDQUFDO3dCQUNKLFVBQVUsR0FBRyxJQUFJLDhCQUFxQixDQUNwQyxNQUFNLEVBQ04sT0FBTyxFQUNQLFdBQVcsQ0FDWixDQUFDO3dCQUNGLE1BQU07b0JBQ1IsS0FBSyxDQUFDO3dCQUNKLFVBQVUsR0FBRyxJQUFJLDZCQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUMvQyxNQUFNO29CQUNSLEtBQUssRUFBRTt3QkFDTCxVQUFVLEdBQUcsSUFBSSx3Q0FBK0IsQ0FBQyxPQUFPLENBQUMsQ0FBQzt3QkFDMUQsTUFBTTtpQkFDVDthQUNGO1lBQUMsV0FBTTtnQkFDTixVQUFVLEdBQUcsSUFBSSx3Q0FBK0IsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDakU7WUFFRCxNQUFNLFVBQVUsQ0FBQztRQUNuQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsU0FBUyxTQUFTLENBQUMsS0FBYTtRQUM5QixJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRTtZQUN0QyxNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7U0FDcEQ7UUFFRCxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFdEIsSUFBSSxJQUFBLHdCQUFRLEdBQUUsRUFBRTtZQUNkLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDYixFQUFFO2dCQUNGLGNBQWMsRUFBRSxTQUFTLENBQUMsY0FBYztnQkFDeEMsTUFBTSxFQUFFLFdBQVc7Z0JBQ25CLE1BQU0sRUFBRSxLQUFLO2FBQ2QsQ0FBQyxDQUNILENBQUM7WUFFRixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyw4RUFBOEUsT0FBTyxFQUFFLENBQUM7U0FDaEg7UUFFRCxPQUFPLFNBQVM7YUFDYixpQkFBaUIsQ0FBQztZQUNqQixFQUFFO1lBQ0YsTUFBTSxFQUFFLFdBQVc7WUFDbkIsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDO1NBQ2hCLENBQUM7YUFDRCxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNmLElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQztZQUV2QixJQUFJO2dCQUNGLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FDbEMsS0FBSyxDQUFDLE9BQU8sQ0FDZCxDQUFDO2dCQUVGLFFBQVEsSUFBSSxFQUFFO29CQUNaLEtBQUssQ0FBQzt3QkFDSixVQUFVLEdBQUcsSUFBSSxnQ0FBdUIsRUFBRSxDQUFDO3dCQUMzQyxNQUFNO29CQUNSLEtBQUssQ0FBQzt3QkFDSixVQUFVLEdBQUcsSUFBSSw2QkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQzt3QkFDL0MsTUFBTTtvQkFDUixLQUFLLEVBQUU7d0JBQ0wsVUFBVSxHQUFHLElBQUksK0NBQXNDLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ2pFLE1BQU07aUJBQ1Q7YUFDRjtZQUFDLFdBQU07Z0JBQ04sVUFBVSxHQUFHLElBQUksK0NBQXNDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3hFO1lBRUQsTUFBTSxVQUFVLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsZ0RBQWdEO0lBQ2hELFNBQVM7SUFDVCxnREFBZ0Q7SUFDaEQsT0FBTztRQUNMLE9BQU87UUFDUCxnQkFBZ0I7UUFDaEIsSUFBSTtRQUNKLFNBQVM7UUFDVCxVQUFVO0tBQ1gsQ0FBQztBQUNKLENBQUM7QUE1VEQsMEJBNFRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXh0ZW5zaW9uT3B0aW9ucyB9IGZyb20gJ0B0ZXJyYS1tb25leS90ZXJyYS5qcyc7XG5pbXBvcnQgQ29ubmVjdG9yIGZyb20gJ0B3YWxsZXRjb25uZWN0L2NvcmUnO1xuaW1wb3J0ICogYXMgY3J5cHRvTGliIGZyb20gJ0B3YWxsZXRjb25uZWN0L2lzby1jcnlwdG8nO1xuaW1wb3J0IHtcbiAgSVB1c2hTZXJ2ZXJPcHRpb25zLFxuICBJV2FsbGV0Q29ubmVjdE9wdGlvbnMsXG59IGZyb20gJ0B3YWxsZXRjb25uZWN0L3R5cGVzJztcbmltcG9ydCB7IHV1aWQgfSBmcm9tICdAd2FsbGV0Y29ubmVjdC91dGlscyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGlzTW9iaWxlIH0gZnJvbSAnLi4vLi4vdXRpbHMvYnJvd3Nlci1jaGVjayc7XG5pbXBvcnQge1xuICBXYWxsZXRDb25uZWN0Q3JlYXRlVHhGYWlsZWQsXG4gIFdhbGxldENvbm5lY3RUaW1lb3V0LFxuICBXYWxsZXRDb25uZWN0VHhGYWlsZWQsXG4gIFdhbGxldENvbm5lY3RUeFVuc3BlY2lmaWVkRXJyb3IsXG4gIFdhbGxldENvbm5lY3RVc2VyRGVuaWVkLFxuICBXYWxsZXRDb25uZWN0U2lnbkJ5dGVzVW5zcGVjaWZpZWRFcnJvclxufSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgU29ja2V0VHJhbnNwb3J0IGZyb20gJy4vaW1wbC9zb2NrZXQtdHJhbnNwb3J0JztcbmltcG9ydCB7IFRlcnJhV2FsbGV0Y29ubmVjdFFyY29kZU1vZGFsIH0gZnJvbSAnLi9tb2RhbCc7XG5pbXBvcnQge1xuICBXYWxsZXRDb25uZWN0U2Vzc2lvbixcbiAgV2FsbGV0Q29ubmVjdFNlc3Npb25TdGF0dXMsXG4gIFdhbGxldENvbm5lY3RUeFJlc3VsdCxcbn0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQge1xuICBXZWJFeHRlbnNpb25TaWduQnl0ZXNQYXlsb2FkLFxufSBmcm9tICdAdGVycmEtbW9uZXkvd2ViLWV4dGVuc2lvbi1pbnRlcmZhY2UnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFdhbGxldENvbm5lY3RDb250cm9sbGVyT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBDb25maWd1cmF0aW9uIHBhcmFtZXRlciB0aGF0IGBuZXcgV2FsbGV0Q29ubmVjdChjb25uZWN0b3JPcHRzKWBcbiAgICpcbiAgICogQGRlZmF1bHRcbiAgICogYGBganNcbiAgICoge1xuICAgKiAgIGJyaWRnZTogJ2h0dHBzOi8vd2FsbGV0Y29ubmVjdC50ZXJyYS5kZXYvJyxcbiAgICogICBxcmNvZGVNb2RhbDogbmV3IFRlcnJhV2FsbGV0Y29ubmVjdFFyY29kZU1vZGFsKCksXG4gICAqIH1cbiAgICogYGBgXG4gICAqL1xuICBjb25uZWN0b3JPcHRzPzogSVdhbGxldENvbm5lY3RPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBDb25maWd1cmF0aW9uIHBhcmFtZXRlciB0aGF0IGBuZXcgV2FsbGV0Q29ubmVjdChfLCBwdXNoU2VydmVyT3B0cylgXG4gICAqXG4gICAqIEBkZWZhdWx0IHVuZGVmaW5lZFxuICAgKi9cbiAgcHVzaFNlcnZlck9wdHM/OiBJUHVzaFNlcnZlck9wdGlvbnM7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2FsbGV0Q29ubmVjdENvbnRyb2xsZXIge1xuICBzZXNzaW9uOiAoKSA9PiBPYnNlcnZhYmxlPFdhbGxldENvbm5lY3RTZXNzaW9uPjtcbiAgZ2V0TGF0ZXN0U2Vzc2lvbjogKCkgPT4gV2FsbGV0Q29ubmVjdFNlc3Npb247XG4gIHBvc3Q6ICh0eDogRXh0ZW5zaW9uT3B0aW9ucykgPT4gUHJvbWlzZTxXYWxsZXRDb25uZWN0VHhSZXN1bHQ+O1xuICBzaWduQnl0ZXM6IChieXRlczogQnVmZmVyKSA9PiBQcm9taXNlPFdlYkV4dGVuc2lvblNpZ25CeXRlc1BheWxvYWQ+O1xuICBkaXNjb25uZWN0OiAoKSA9PiB2b2lkO1xufVxuXG5jb25zdCBXQUxMRVRDT05ORUNUX1NUT1JBR0VfS0VZID0gJ3dhbGxldGNvbm5lY3QnO1xuXG5leHBvcnQgZnVuY3Rpb24gY29ubmVjdElmU2Vzc2lvbkV4aXN0cyhcbiAgb3B0aW9uczogV2FsbGV0Q29ubmVjdENvbnRyb2xsZXJPcHRpb25zID0ge30sXG4pOiBXYWxsZXRDb25uZWN0Q29udHJvbGxlciB8IG51bGwge1xuICBjb25zdCBzdG9yZWRTZXNzaW9uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oV0FMTEVUQ09OTkVDVF9TVE9SQUdFX0tFWSk7XG5cbiAgaWYgKHR5cGVvZiBzdG9yZWRTZXNzaW9uID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBjb25uZWN0KG9wdGlvbnMsIHRydWUpO1xuICB9XG5cbiAgcmV0dXJuIG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25uZWN0KFxuICBvcHRpb25zOiBXYWxsZXRDb25uZWN0Q29udHJvbGxlck9wdGlvbnMgPSB7fSxcbiAgdXNlQ2FjaGVkU2Vzc2lvbjogYm9vbGVhbiA9IGZhbHNlLFxuKTogV2FsbGV0Q29ubmVjdENvbnRyb2xsZXIge1xuICBsZXQgY29ubmVjdG9yOiBDb25uZWN0b3IgfCBudWxsID0gbnVsbDtcblxuICBsZXQgc2Vzc2lvblN1YmplY3Q6IEJlaGF2aW9yU3ViamVjdDxXYWxsZXRDb25uZWN0U2Vzc2lvbj4gPVxuICAgIG5ldyBCZWhhdmlvclN1YmplY3Q8V2FsbGV0Q29ubmVjdFNlc3Npb24+KHtcbiAgICAgIHN0YXR1czogV2FsbGV0Q29ubmVjdFNlc3Npb25TdGF0dXMuRElTQ09OTkVDVEVELFxuICAgIH0pO1xuXG4gIGNvbnN0IHFyY29kZU1vZGFsID1cbiAgICBvcHRpb25zLmNvbm5lY3Rvck9wdHM/LnFyY29kZU1vZGFsID8/IG5ldyBUZXJyYVdhbGxldGNvbm5lY3RRcmNvZGVNb2RhbCgpO1xuXG4gIGNvbnN0IGNvbm5lY3Rvck9wdHM6IElXYWxsZXRDb25uZWN0T3B0aW9ucyA9IHtcbiAgICBicmlkZ2U6ICdodHRwczovL3dhbGxldGNvbm5lY3QudGVycmEuZGV2LycsXG4gICAgcXJjb2RlTW9kYWwsXG4gICAgLi4ub3B0aW9ucy5jb25uZWN0b3JPcHRzLFxuICB9O1xuXG4gIGNvbnN0IHB1c2hTZXJ2ZXJPcHRzOiBJUHVzaFNlcnZlck9wdGlvbnMgfCB1bmRlZmluZWQgPSBvcHRpb25zLnB1c2hTZXJ2ZXJPcHRzO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBldmVudCBsaXN0ZW5lcnNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIGZ1bmN0aW9uIGluaXRFdmVudHMoKSB7XG4gICAgaWYgKCFjb25uZWN0b3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgV2FsbGV0Q29ubmVjdCBpcyBub3QgZGVmaW5lZCFgKTtcbiAgICB9XG5cbiAgICBjb25uZWN0b3Iub24oJ3Nlc3Npb25fdXBkYXRlJywgYXN5bmMgKGVycm9yLCBwYXlsb2FkKSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xuXG4gICAgICBzZXNzaW9uU3ViamVjdC5uZXh0KHtcbiAgICAgICAgc3RhdHVzOiBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cy5DT05ORUNURUQsXG4gICAgICAgIHBlZXJNZXRhOiBwYXlsb2FkLnBhcmFtc1swXSxcbiAgICAgICAgdGVycmFBZGRyZXNzOiBwYXlsb2FkLnBhcmFtc1swXS5hY2NvdW50c1swXSxcbiAgICAgICAgY2hhaW5JZDogcGF5bG9hZC5wYXJhbXNbMF0uY2hhaW5JZCxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zb2xlLmxvZygnV0FMTEVUQ09OTkVDVCBTRVNTSU9OIFVQREFURUQ6JywgcGF5bG9hZC5wYXJhbXNbMF0pO1xuICAgIH0pO1xuXG4gICAgY29ubmVjdG9yLm9uKCdjb25uZWN0JywgKGVycm9yLCBwYXlsb2FkKSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xuXG4gICAgICBzZXNzaW9uU3ViamVjdC5uZXh0KHtcbiAgICAgICAgc3RhdHVzOiBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cy5DT05ORUNURUQsXG4gICAgICAgIHBlZXJNZXRhOiBwYXlsb2FkLnBhcmFtc1swXSxcbiAgICAgICAgdGVycmFBZGRyZXNzOiBwYXlsb2FkLnBhcmFtc1swXS5hY2NvdW50c1swXSxcbiAgICAgICAgY2hhaW5JZDogcGF5bG9hZC5wYXJhbXNbMF0uY2hhaW5JZCxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29ubmVjdG9yLm9uKCdkaXNjb25uZWN0JywgKGVycm9yLCBwYXlsb2FkKSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yO1xuXG4gICAgICBzZXNzaW9uU3ViamVjdC5uZXh0KHtcbiAgICAgICAgc3RhdHVzOiBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cy5ESVNDT05ORUNURUQsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBpbml0aWFsaXplXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBjb25zdCBjYWNoZWRTZXNzaW9uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3dhbGxldGNvbm5lY3QnKTtcblxuICBpZiAodHlwZW9mIGNhY2hlZFNlc3Npb24gPT09ICdzdHJpbmcnICYmIHVzZUNhY2hlZFNlc3Npb24pIHtcbiAgICBjb25zdCBjYWNoZWRTZXNzaW9uT2JqZWN0ID0gSlNPTi5wYXJzZShjYWNoZWRTZXNzaW9uKTtcbiAgICBjb25zdCBjbGllbnRJZCA9IGNhY2hlZFNlc3Npb25PYmplY3QuY2xpZW50SWQ7XG4gICAgY29uc3QgZHJhZnRDb25uZWN0b3IgPSBuZXcgQ29ubmVjdG9yKHtcbiAgICAgIGNvbm5lY3Rvck9wdHM6IHtcbiAgICAgICAgLi4uY29ubmVjdG9yT3B0cyxcbiAgICAgICAgc2Vzc2lvbjogSlNPTi5wYXJzZShjYWNoZWRTZXNzaW9uKSxcbiAgICAgIH0sXG4gICAgICBwdXNoU2VydmVyT3B0cyxcbiAgICAgIGNyeXB0b0xpYixcbiAgICAgIHRyYW5zcG9ydDogbmV3IFNvY2tldFRyYW5zcG9ydCh7XG4gICAgICAgIHByb3RvY29sOiAnd2MnLFxuICAgICAgICB2ZXJzaW9uOiAxLFxuICAgICAgICB1cmw6IGNvbm5lY3Rvck9wdHMuYnJpZGdlISxcbiAgICAgICAgc3Vic2NyaXB0aW9uczogW2NsaWVudElkXSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIGRyYWZ0Q29ubmVjdG9yLmNsaWVudElkID0gY2xpZW50SWQ7XG5cbiAgICBjb25uZWN0b3IgPSBkcmFmdENvbm5lY3RvcjtcblxuICAgIGluaXRFdmVudHMoKTtcblxuICAgIHNlc3Npb25TdWJqZWN0Lm5leHQoe1xuICAgICAgc3RhdHVzOiBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cy5DT05ORUNURUQsXG4gICAgICBwZWVyTWV0YTogZHJhZnRDb25uZWN0b3IucGVlck1ldGEhLFxuICAgICAgdGVycmFBZGRyZXNzOiBkcmFmdENvbm5lY3Rvci5hY2NvdW50c1swXSxcbiAgICAgIGNoYWluSWQ6IGRyYWZ0Q29ubmVjdG9yLmNoYWluSWQsXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY2xpZW50SWQgPSB1dWlkKCk7XG4gICAgY29uc3QgZHJhZnRDb25uZWN0b3IgPSBuZXcgQ29ubmVjdG9yKHtcbiAgICAgIGNvbm5lY3Rvck9wdHMsXG4gICAgICBwdXNoU2VydmVyT3B0cyxcbiAgICAgIGNyeXB0b0xpYixcbiAgICAgIHRyYW5zcG9ydDogbmV3IFNvY2tldFRyYW5zcG9ydCh7XG4gICAgICAgIHByb3RvY29sOiAnd2MnLFxuICAgICAgICB2ZXJzaW9uOiAxLFxuICAgICAgICB1cmw6IGNvbm5lY3Rvck9wdHMuYnJpZGdlISxcbiAgICAgICAgc3Vic2NyaXB0aW9uczogW2NsaWVudElkXSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIGRyYWZ0Q29ubmVjdG9yLmNsaWVudElkID0gY2xpZW50SWQ7XG5cbiAgICBjb25uZWN0b3IgPSBkcmFmdENvbm5lY3RvcjtcblxuICAgIGlmICghZHJhZnRDb25uZWN0b3IuY29ubmVjdGVkKSB7XG4gICAgICBkcmFmdENvbm5lY3Rvci5jcmVhdGVTZXNzaW9uKCkuY2F0Y2goY29uc29sZS5lcnJvcik7XG5cbiAgICAgIGlmIChxcmNvZGVNb2RhbCBpbnN0YW5jZW9mIFRlcnJhV2FsbGV0Y29ubmVjdFFyY29kZU1vZGFsKSB7XG4gICAgICAgIHFyY29kZU1vZGFsLnNldENsb3NlQ2FsbGJhY2soKCkgPT4ge1xuICAgICAgICAgIHNlc3Npb25TdWJqZWN0Lm5leHQoe1xuICAgICAgICAgICAgc3RhdHVzOiBXYWxsZXRDb25uZWN0U2Vzc2lvblN0YXR1cy5ESVNDT05ORUNURUQsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpbml0RXZlbnRzKCk7XG5cbiAgICAgIHNlc3Npb25TdWJqZWN0Lm5leHQoe1xuICAgICAgICBzdGF0dXM6IFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLlJFUVVFU1RFRCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBtZXRob2RzXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBmdW5jdGlvbiBkaXNjb25uZWN0KCkge1xuICAgIGlmIChjb25uZWN0b3IgJiYgY29ubmVjdG9yLmNvbm5lY3RlZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29ubmVjdG9yLmtpbGxTZXNzaW9uKCk7XG4gICAgICB9IGNhdGNoIHt9XG4gICAgfVxuXG4gICAgc2Vzc2lvblN1YmplY3QubmV4dCh7XG4gICAgICBzdGF0dXM6IFdhbGxldENvbm5lY3RTZXNzaW9uU3RhdHVzLkRJU0NPTk5FQ1RFRCxcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHNlc3Npb24oKTogT2JzZXJ2YWJsZTxXYWxsZXRDb25uZWN0U2Vzc2lvbj4ge1xuICAgIHJldHVybiBzZXNzaW9uU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldExhdGVzdFNlc3Npb24oKTogV2FsbGV0Q29ubmVjdFNlc3Npb24ge1xuICAgIHJldHVybiBzZXNzaW9uU3ViamVjdC5nZXRWYWx1ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIHBvc3QgdHJhbnNhY3Rpb25cbiAgICpcbiAgICogQHBhcmFtIHR4IHRyYW5zYWN0aW9uIGRhdGFcbiAgICogQHRocm93cyB7IFdhbGxldENvbm5lY3RVc2VyRGVuaWVkIH1cbiAgICogQHRocm93cyB7IFdhbGxldENvbm5lY3RDcmVhdGVUeEZhaWxlZCB9XG4gICAqIEB0aHJvd3MgeyBXYWxsZXRDb25uZWN0VHhGYWlsZWQgfVxuICAgKiBAdGhyb3dzIHsgV2FsbGV0Q29ubmVjdFRpbWVvdXQgfVxuICAgKiBAdGhyb3dzIHsgV2FsbGV0Q29ubmVjdFR4VW5zcGVjaWZpZWRFcnJvciB9XG4gICAqL1xuICBmdW5jdGlvbiBwb3N0KHR4OiBFeHRlbnNpb25PcHRpb25zKTogUHJvbWlzZTxXYWxsZXRDb25uZWN0VHhSZXN1bHQ+IHtcbiAgICBpZiAoIWNvbm5lY3RvciB8fCAhY29ubmVjdG9yLmNvbm5lY3RlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBXYWxsZXRDb25uZWN0IGlzIG5vdCBjb25uZWN0ZWQhYCk7XG4gICAgfVxuXG4gICAgY29uc3QgaWQgPSBEYXRlLm5vdygpO1xuXG4gICAgY29uc3Qgc2VyaWFsaXplZFR4T3B0aW9ucyA9IHtcbiAgICAgIG1zZ3M6IHR4Lm1zZ3MubWFwKChtc2cpID0+IG1zZy50b0pTT04odHguaXNDbGFzc2ljKSksXG4gICAgICBmZWU6IHR4LmZlZT8udG9KU09OKHR4LmlzQ2xhc3NpYyksXG4gICAgICBtZW1vOiB0eC5tZW1vLFxuICAgICAgZ2FzOiB0eC5nYXMsXG4gICAgICBnYXNQcmljZXM6IHR4Lmdhc1ByaWNlcz8udG9TdHJpbmcoKSxcbiAgICAgIGdhc0FkanVzdG1lbnQ6IHR4Lmdhc0FkanVzdG1lbnQ/LnRvU3RyaW5nKCksXG4gICAgICAvL2FjY291bnRfbnVtYmVyOiB0eC5hY2NvdW50X251bWJlcixcbiAgICAgIC8vc2VxdWVuY2U6IHR4LnNlcXVlbmNlLFxuICAgICAgZmVlRGVub21zOiB0eC5mZWVEZW5vbXMsXG4gICAgICB0aW1lb3V0SGVpZ2h0OiB0eC50aW1lb3V0SGVpZ2h0LFxuICAgIH07XG5cbiAgICBpZiAoaXNNb2JpbGUoKSkge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGJ0b2EoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBoYW5kc2hha2VUb3BpYzogY29ubmVjdG9yLmhhbmRzaGFrZVRvcGljLFxuICAgICAgICAgIG1ldGhvZDogJ3Bvc3QnLFxuICAgICAgICAgIHBhcmFtczogc2VyaWFsaXplZFR4T3B0aW9ucyxcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgICAvLyBGSVhNRSBjaGFuZ2VkIHdhbGxldGNvbm5lY3QgY29uZmlybSBzY2hlbWFcbiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gYHRlcnJhc3RhdGlvbjovL3dhbGxldGNvbm5lY3RfY29uZmlybS8/YWN0aW9uPXdhbGxldGNvbm5lY3RfY29uZmlybSZwYXlsb2FkPSR7cGF5bG9hZH1gO1xuICAgICAgLy93aW5kb3cubG9jYXRpb24uaHJlZiA9IGB0ZXJyYXN0YXRpb246Ly93YWxsZXRfY29ubmVjdF9jb25maXJtP2lkPSR7aWR9JmhhbmRzaGFrZVRvcGljPSR7XG4gICAgICAvLyAgY29ubmVjdG9yLmhhbmRzaGFrZVRvcGljXG4gICAgICAvL30mcGFyYW1zPSR7SlNPTi5zdHJpbmdpZnkoW3NlcmlhbGl6ZWRUeE9wdGlvbnNdKX1gO1xuICAgIH1cblxuICAgIHJldHVybiBjb25uZWN0b3JcbiAgICAgIC5zZW5kQ3VzdG9tUmVxdWVzdCh7XG4gICAgICAgIGlkLFxuICAgICAgICBtZXRob2Q6ICdwb3N0JyxcbiAgICAgICAgcGFyYW1zOiBbc2VyaWFsaXplZFR4T3B0aW9uc10sXG4gICAgICB9KVxuICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICBsZXQgdGhyb3dFcnJvciA9IGVycm9yO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgeyBjb2RlLCB0eGhhc2gsIG1lc3NhZ2UsIHJhd19tZXNzYWdlIH0gPSBKU09OLnBhcnNlKFxuICAgICAgICAgICAgZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICApO1xuICAgICAgICAgIHN3aXRjaCAoY29kZSkge1xuICAgICAgICAgICAgY2FzZSAxOlxuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFdhbGxldENvbm5lY3RVc2VyRGVuaWVkKCk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFdhbGxldENvbm5lY3RDcmVhdGVUeEZhaWxlZChtZXNzYWdlKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDM6XG4gICAgICAgICAgICAgIHRocm93RXJyb3IgPSBuZXcgV2FsbGV0Q29ubmVjdFR4RmFpbGVkKFxuICAgICAgICAgICAgICAgIHR4aGFzaCxcbiAgICAgICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgICAgIHJhd19tZXNzYWdlLFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgNDpcbiAgICAgICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBXYWxsZXRDb25uZWN0VGltZW91dChtZXNzYWdlKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDk5OlxuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFdhbGxldENvbm5lY3RUeFVuc3BlY2lmaWVkRXJyb3IobWVzc2FnZSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBXYWxsZXRDb25uZWN0VHhVbnNwZWNpZmllZEVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgdGhyb3dFcnJvcjtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIHNpZ25CeXRlcyB0cmFuc2FjdGlvblxuICAgKlxuICAgKiBAcGFyYW0gYnl0ZXM6IEJ1ZmZlclxuICAgKiBAdGhyb3dzIHsgV2FsbGV0Q29ubmVjdFVzZXJEZW5pZWQgfVxuICAgKiBAdGhyb3dzIHsgV2FsbGV0Q29ubmVjdFRpbWVvdXQgfVxuICAgKiBAdGhyb3dzIHsgV2FsbGV0Q29ubmVjdFNpZ25CeXRlc1Vuc3BlY2lmaWVkRXJyb3IgfVxuICAgKi9cbiAgZnVuY3Rpb24gc2lnbkJ5dGVzKGJ5dGVzOiBCdWZmZXIpOiBQcm9taXNlPFdlYkV4dGVuc2lvblNpZ25CeXRlc1BheWxvYWQ+IHtcbiAgICBpZiAoIWNvbm5lY3RvciB8fCAhY29ubmVjdG9yLmNvbm5lY3RlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBXYWxsZXRDb25uZWN0IGlzIG5vdCBjb25uZWN0ZWQhYCk7XG4gICAgfVxuXG4gICAgY29uc3QgaWQgPSBEYXRlLm5vdygpO1xuXG4gICAgaWYgKGlzTW9iaWxlKCkpIHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBidG9hKFxuICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgaWQsXG4gICAgICAgICAgaGFuZHNoYWtlVG9waWM6IGNvbm5lY3Rvci5oYW5kc2hha2VUb3BpYyxcbiAgICAgICAgICBtZXRob2Q6ICdzaWduQnl0ZXMnLFxuICAgICAgICAgIHBhcmFtczogYnl0ZXMsXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBgdGVycmFzdGF0aW9uOi8vd2FsbGV0Y29ubmVjdF9jb25maXJtLz9hY3Rpb249d2FsbGV0Y29ubmVjdF9jb25maXJtJnBheWxvYWQ9JHtwYXlsb2FkfWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbm5lY3RvclxuICAgICAgLnNlbmRDdXN0b21SZXF1ZXN0KHtcbiAgICAgICAgaWQsXG4gICAgICAgIG1ldGhvZDogJ3NpZ25CeXRlcycsXG4gICAgICAgIHBhcmFtczogW2J5dGVzXSxcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgIGxldCB0aHJvd0Vycm9yID0gZXJyb3I7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCB7IGNvZGUsIG1lc3NhZ2UgfSA9IEpTT04ucGFyc2UoXG4gICAgICAgICAgICBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBzd2l0Y2ggKGNvZGUpIHtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBXYWxsZXRDb25uZWN0VXNlckRlbmllZCgpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgNDpcbiAgICAgICAgICAgICAgdGhyb3dFcnJvciA9IG5ldyBXYWxsZXRDb25uZWN0VGltZW91dChtZXNzYWdlKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDk5OlxuICAgICAgICAgICAgICB0aHJvd0Vycm9yID0gbmV3IFdhbGxldENvbm5lY3RTaWduQnl0ZXNVbnNwZWNpZmllZEVycm9yKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgIHRocm93RXJyb3IgPSBuZXcgV2FsbGV0Q29ubmVjdFNpZ25CeXRlc1Vuc3BlY2lmaWVkRXJyb3IoZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aHJvdyB0aHJvd0Vycm9yO1xuICAgICAgfSk7XG4gIH1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gcmV0dXJuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICByZXR1cm4ge1xuICAgIHNlc3Npb24sXG4gICAgZ2V0TGF0ZXN0U2Vzc2lvbixcbiAgICBwb3N0LFxuICAgIHNpZ25CeXRlcyxcbiAgICBkaXNjb25uZWN0LFxuICB9O1xufVxuIl19