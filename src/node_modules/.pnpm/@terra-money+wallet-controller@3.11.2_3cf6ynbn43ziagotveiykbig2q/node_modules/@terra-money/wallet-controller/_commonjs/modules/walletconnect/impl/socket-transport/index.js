"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("@walletconnect/utils");
const network_1 = __importDefault(require("./network"));
// @ts-ignore
const WS = typeof global.WebSocket !== 'undefined' ? global.WebSocket : require('ws');
// -- SocketTransport ------------------------------------------------------ //
class SocketTransport {
    // -- constructor ----------------------------------------------------- //
    constructor(opts) {
        this.opts = opts;
        this._queue = [];
        this._events = [];
        this._subscriptions = [];
        // -- public ---------------------------------------------------------- //
        this.open = () => {
            this._socketCreate();
        };
        this.close = () => {
            this._socketClose();
        };
        this.send = (message, topic, silent) => {
            if (!topic || typeof topic !== 'string') {
                throw new Error('Missing or invalid topic field');
            }
            this._socketSend({
                topic: topic,
                type: 'pub',
                payload: message,
                silent: !!silent,
            });
        };
        this.subscribe = (topic) => {
            this._socketSend({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            });
        };
        this.on = (event, callback) => {
            this._events.push({ event, callback });
        };
        // -- private ---------------------------------------------------------- //
        this._socketCreate = () => {
            if (this._nextSocket) {
                return;
            }
            const url = getWebSocketUrl(this._url, this._protocol, this._version);
            this._nextSocket = new WS(url);
            if (!this._nextSocket) {
                throw new Error('Failed to create socket');
            }
            this._nextSocket.onmessage = (event) => this._socketReceive(event);
            this._nextSocket.onopen = () => this._socketOpen();
            this._nextSocket.onerror = (event) => this._socketError(event);
            this._nextSocket.onclose = () => {
                this._nextSocket = null;
                setTimeout(this._socketCreate, 500);
            };
        };
        this._socketOpen = () => {
            this._socketClose();
            this._socket = this._nextSocket;
            this._nextSocket = null;
            this._queueSubscriptions();
            this._pushQueue();
        };
        this._socketClose = () => {
            if (this._socket) {
                this._socket.onclose = () => {
                    // empty
                };
                this._socket.close();
            }
        };
        this._socketSend = (socketMessage) => {
            const message = JSON.stringify(socketMessage);
            if (this._socket && this._socket.readyState === 1) {
                this._socket.send(message);
            }
            else {
                this._setToQueue(socketMessage);
                this._socketCreate();
            }
        };
        this._socketReceive = async (event) => {
            let socketMessage;
            try {
                socketMessage = JSON.parse(event.data);
            }
            catch (error) {
                return;
            }
            this._socketSend({
                topic: socketMessage.topic,
                type: 'ack',
                payload: '',
                silent: true,
            });
            if (this._socket && this._socket.readyState === 1) {
                const events = this._events.filter((itemEvent) => itemEvent.event === 'message');
                if (events && events.length) {
                    events.forEach((itemEvent) => itemEvent.callback(socketMessage));
                }
            }
        };
        this._socketError = (e) => {
            const events = this._events.filter((event) => event.event === 'error');
            if (events && events.length) {
                events.forEach((event) => event.callback(e));
            }
        };
        this._queueSubscriptions = () => {
            const subscriptions = this._subscriptions;
            subscriptions.forEach((topic) => this._queue.push({
                topic: topic,
                type: 'sub',
                payload: '',
                silent: true,
            }));
            this._subscriptions = this.opts.subscriptions || [];
        };
        this._setToQueue = (socketMessage) => {
            this._queue.push(socketMessage);
        };
        this._pushQueue = () => {
            const queue = this._queue;
            queue.forEach((socketMessage) => this._socketSend(socketMessage));
            this._queue = [];
        };
        this._protocol = opts.protocol;
        this._version = opts.version;
        this._url = '';
        this._netMonitor = null;
        this._socket = null;
        this._nextSocket = null;
        this._subscriptions = opts.subscriptions || [];
        this._netMonitor = opts.netMonitor || new network_1.default();
        if (!opts.url || typeof opts.url !== 'string') {
            throw new Error('Missing or invalid WebSocket url');
        }
        this._url = opts.url;
        this._netMonitor.on('online', () => this._socketCreate());
    }
    set readyState(value) {
        // empty
    }
    get readyState() {
        return this._socket ? this._socket.readyState : -1;
    }
    set connecting(value) {
        // empty
    }
    get connecting() {
        return this.readyState === 0;
    }
    set connected(value) {
        // empty
    }
    get connected() {
        return this.readyState === 1;
    }
    set closing(value) {
        // empty
    }
    get closing() {
        return this.readyState === 2;
    }
    set closed(value) {
        // empty
    }
    get closed() {
        return this.readyState === 3;
    }
}
function getWebSocketUrl(webUrl, protocol, version) {
    var _a, _b;
    const url = webUrl.startsWith('https')
        ? webUrl.replace('https', 'wss')
        : webUrl.startsWith('http')
            ? webUrl.replace('http', 'ws')
            : webUrl;
    const splitUrl = url.split('?');
    const params = (0, utils_1.isBrowser)()
        ? {
            protocol,
            version,
            env: 'browser',
            host: ((_a = (0, utils_1.getLocation)()) === null || _a === void 0 ? void 0 : _a.host) || '',
        }
        : {
            protocol,
            version,
            env: ((_b = (0, utils_1.detectEnv)()) === null || _b === void 0 ? void 0 : _b.name) || '',
        };
    const queryString = (0, utils_1.appendToQueryString)((0, utils_1.getQueryString)(splitUrl[1] || ''), params);
    return splitUrl[0] + '?' + queryString;
}
exports.default = SocketTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvQHRlcnJhLW1vbmV5L3dhbGxldC1jb250cm9sbGVyL21vZHVsZXMvd2FsbGV0Y29ubmVjdC9pbXBsL3NvY2tldC10cmFuc3BvcnQvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFPQSxnREFNOEI7QUFFOUIsd0RBQXVDO0FBRXZDLGFBQWE7QUFDYixNQUFNLEVBQUUsR0FDTixPQUFPLE1BQU0sQ0FBQyxTQUFTLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFN0UsK0VBQStFO0FBRS9FLE1BQU0sZUFBZTtJQVduQiwwRUFBMEU7SUFFMUUsWUFBb0IsSUFBNkI7UUFBN0IsU0FBSSxHQUFKLElBQUksQ0FBeUI7UUFOekMsV0FBTSxHQUFxQixFQUFFLENBQUM7UUFDOUIsWUFBTyxHQUFzQixFQUFFLENBQUM7UUFDaEMsbUJBQWMsR0FBYSxFQUFFLENBQUM7UUErRHRDLDBFQUEwRTtRQUVuRSxTQUFJLEdBQUcsR0FBRyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN2QixDQUFDLENBQUM7UUFFSyxVQUFLLEdBQUcsR0FBRyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUN0QixDQUFDLENBQUM7UUFFSyxTQUFJLEdBQUcsQ0FBQyxPQUFlLEVBQUUsS0FBYyxFQUFFLE1BQWdCLEVBQVEsRUFBRTtZQUN4RSxJQUFJLENBQUMsS0FBSyxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtnQkFDdkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO2FBQ25EO1lBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQztnQkFDZixLQUFLLEVBQUUsS0FBSztnQkFDWixJQUFJLEVB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YyxFQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsRUFDakMsTUFBTSxDQUNQLENBQUM7SUFDRixPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsV0FBVyxDQUFDO0FBQ3pDLENBQUM7QUFFRCxrQkFBZSxlQUFlLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJU29ja2V0TWVzc2FnZSxcbiAgSVRyYW5zcG9ydEV2ZW50LFxuICBJTmV0d29ya01vbml0b3IsXG4gIElUcmFuc3BvcnRMaWIsXG4gIElTb2NrZXRUcmFuc3BvcnRPcHRpb25zLFxufSBmcm9tICdAd2FsbGV0Y29ubmVjdC90eXBlcyc7XG5pbXBvcnQge1xuICBpc0Jyb3dzZXIsXG4gIGdldExvY2F0aW9uLFxuICBnZXRRdWVyeVN0cmluZyxcbiAgZGV0ZWN0RW52LFxuICBhcHBlbmRUb1F1ZXJ5U3RyaW5nLFxufSBmcm9tICdAd2FsbGV0Y29ubmVjdC91dGlscyc7XG5cbmltcG9ydCBOZXR3b3JrTW9uaXRvciBmcm9tICcuL25ldHdvcmsnO1xuXG4vLyBAdHMtaWdub3JlXG5jb25zdCBXUyA9XG4gIHR5cGVvZiBnbG9iYWwuV2ViU29ja2V0ICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbC5XZWJTb2NrZXQgOiByZXF1aXJlKCd3cycpO1xuXG4vLyAtLSBTb2NrZXRUcmFuc3BvcnQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vXG5cbmNsYXNzIFNvY2tldFRyYW5zcG9ydCBpbXBsZW1lbnRzIElUcmFuc3BvcnRMaWIge1xuICBwcml2YXRlIF9wcm90b2NvbDogc3RyaW5nO1xuICBwcml2YXRlIF92ZXJzaW9uOiBudW1iZXI7XG4gIHByaXZhdGUgX3VybDogc3RyaW5nO1xuICBwcml2YXRlIF9uZXRNb25pdG9yOiBJTmV0d29ya01vbml0b3IgfCBudWxsO1xuICBwcml2YXRlIF9zb2NrZXQ6IFdlYlNvY2tldCB8IG51bGw7XG4gIHByaXZhdGUgX25leHRTb2NrZXQ6IFdlYlNvY2tldCB8IG51bGw7XG4gIHByaXZhdGUgX3F1ZXVlOiBJU29ja2V0TWVzc2FnZVtdID0gW107XG4gIHByaXZhdGUgX2V2ZW50czogSVRyYW5zcG9ydEV2ZW50W10gPSBbXTtcbiAgcHJpdmF0ZSBfc3Vic2NyaXB0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICAvLyAtLSBjb25zdHJ1Y3RvciAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvL1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3B0czogSVNvY2tldFRyYW5zcG9ydE9wdGlvbnMpIHtcbiAgICB0aGlzLl9wcm90b2NvbCA9IG9wdHMucHJvdG9jb2w7XG4gICAgdGhpcy5fdmVyc2lvbiA9IG9wdHMudmVyc2lvbjtcbiAgICB0aGlzLl91cmwgPSAnJztcbiAgICB0aGlzLl9uZXRNb25pdG9yID0gbnVsbDtcbiAgICB0aGlzLl9zb2NrZXQgPSBudWxsO1xuICAgIHRoaXMuX25leHRTb2NrZXQgPSBudWxsO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBvcHRzLnN1YnNjcmlwdGlvbnMgfHwgW107XG4gICAgdGhpcy5fbmV0TW9uaXRvciA9IG9wdHMubmV0TW9uaXRvciB8fCBuZXcgTmV0d29ya01vbml0b3IoKTtcblxuICAgIGlmICghb3B0cy51cmwgfHwgdHlwZW9mIG9wdHMudXJsICE9PSAnc3RyaW5nJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIG9yIGludmFsaWQgV2ViU29ja2V0IHVybCcpO1xuICAgIH1cblxuICAgIHRoaXMuX3VybCA9IG9wdHMudXJsO1xuXG4gICAgdGhpcy5fbmV0TW9uaXRvci5vbignb25saW5lJywgKCkgPT4gdGhpcy5fc29ja2V0Q3JlYXRlKCkpO1xuICB9XG5cbiAgc2V0IHJlYWR5U3RhdGUodmFsdWUpIHtcbiAgICAvLyBlbXB0eVxuICB9XG5cbiAgZ2V0IHJlYWR5U3RhdGUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fc29ja2V0ID8gdGhpcy5fc29ja2V0LnJlYWR5U3RhdGUgOiAtMTtcbiAgfVxuXG4gIHNldCBjb25uZWN0aW5nKHZhbHVlKSB7XG4gICAgLy8gZW1wdHlcbiAgfVxuXG4gIGdldCBjb25uZWN0aW5nKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJlYWR5U3RhdGUgPT09IDA7XG4gIH1cblxuICBzZXQgY29ubmVjdGVkKHZhbHVlKSB7XG4gICAgLy8gZW1wdHlcbiAgfVxuXG4gIGdldCBjb25uZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZHlTdGF0ZSA9PT0gMTtcbiAgfVxuXG4gIHNldCBjbG9zaW5nKHZhbHVlKSB7XG4gICAgLy8gZW1wdHlcbiAgfVxuXG4gIGdldCBjbG9zaW5nKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJlYWR5U3RhdGUgPT09IDI7XG4gIH1cblxuICBzZXQgY2xvc2VkKHZhbHVlKSB7XG4gICAgLy8gZW1wdHlcbiAgfVxuXG4gIGdldCBjbG9zZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucmVhZHlTdGF0ZSA9PT0gMztcbiAgfVxuXG4gIC8vIC0tIHB1YmxpYyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIC8vXG5cbiAgcHVibGljIG9wZW4gPSAoKSA9PiB7XG4gICAgdGhpcy5fc29ja2V0Q3JlYXRlKCk7XG4gIH07XG5cbiAgcHVibGljIGNsb3NlID0gKCkgPT4ge1xuICAgIHRoaXMuX3NvY2tldENsb3NlKCk7XG4gIH07XG5cbiAgcHVibGljIHNlbmQgPSAobWVzc2FnZTogc3RyaW5nLCB0b3BpYz86IHN0cmluZywgc2lsZW50PzogYm9vbGVhbik6IHZvaWQgPT4ge1xuICAgIGlmICghdG9waWMgfHwgdHlwZW9mIHRvcGljICE9PSAnc3RyaW5nJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIG9yIGludmFsaWQgdG9waWMgZmllbGQnKTtcbiAgICB9XG5cbiAgICB0aGlzLl9zb2NrZXRTZW5kKHtcbiAgICAgIHRvcGljOiB0b3BpYyxcbiAgICAgIHR5cGU6ICdwdWInLFxuICAgICAgcGF5bG9hZDogbWVzc2FnZSxcbiAgICAgIHNpbGVudDogISFzaWxlbnQsXG4gICAgfSk7XG4gIH07XG5cbiAgcHVibGljIHN1YnNjcmliZSA9ICh0b3BpYzogc3RyaW5nKSA9PiB7XG4gICAgdGhpcy5fc29ja2V0U2VuZCh7XG4gICAgICB0b3BpYzogdG9waWMsXG4gICAgICB0eXBlOiAnc3ViJyxcbiAgICAgIHBheWxvYWQ6ICcnLFxuICAgICAgc2lsZW50OiB0cnVlLFxuICAgIH0pO1xuICB9O1xuXG4gIHB1YmxpYyBvbiA9IChldmVudDogc3RyaW5nLCBjYWxsYmFjazogKHBheWxvYWQ6IGFueSkgPT4gdm9pZCkgPT4ge1xuICAgIHRoaXMuX2V2ZW50cy5wdXNoKHsgZXZlbnQsIGNhbGxiYWNrIH0pO1xuICB9O1xuXG4gIC8vIC0tIHByaXZhdGUgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAvL1xuXG4gIHByaXZhdGUgX3NvY2tldENyZWF0ZSA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5fbmV4dFNvY2tldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHVybCA9IGdldFdlYlNvY2tldFVybCh0aGlzLl91cmwsIHRoaXMuX3Byb3RvY29sLCB0aGlzLl92ZXJzaW9uKTtcblxuICAgIHRoaXMuX25leHRTb2NrZXQgPSBuZXcgV1ModXJsKTtcblxuICAgIGlmICghdGhpcy5fbmV4dFNvY2tldCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIHNvY2tldCcpO1xuICAgIH1cblxuICAgIHRoaXMuX25leHRTb2NrZXQub25tZXNzYWdlID0gKGV2ZW50OiBNZXNzYWdlRXZlbnQpID0+XG4gICAgICB0aGlzLl9zb2NrZXRSZWNlaXZlKGV2ZW50KTtcblxuICAgIHRoaXMuX25leHRTb2NrZXQub25vcGVuID0gKCkgPT4gdGhpcy5fc29ja2V0T3BlbigpO1xuXG4gICAgdGhpcy5fbmV4dFNvY2tldC5vbmVycm9yID0gKGV2ZW50OiBFdmVudCkgPT4gdGhpcy5fc29ja2V0RXJyb3IoZXZlbnQpO1xuXG4gICAgdGhpcy5fbmV4dFNvY2tldC5vbmNsb3NlID0gKCkgPT4ge1xuICAgICAgdGhpcy5fbmV4dFNvY2tldCA9IG51bGw7XG4gICAgICBzZXRUaW1lb3V0KHRoaXMuX3NvY2tldENyZWF0ZSwgNTAwKTtcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgX3NvY2tldE9wZW4gPSAoKSA9PiB7XG4gICAgdGhpcy5fc29ja2V0Q2xvc2UoKTtcbiAgICB0aGlzLl9zb2NrZXQgPSB0aGlzLl9uZXh0U29ja2V0O1xuICAgIHRoaXMuX25leHRTb2NrZXQgPSBudWxsO1xuICAgIHRoaXMuX3F1ZXVlU3Vic2NyaXB0aW9ucygpO1xuICAgIHRoaXMuX3B1c2hRdWV1ZSgpO1xuICB9O1xuXG4gIHByaXZhdGUgX3NvY2tldENsb3NlID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLl9zb2NrZXQpIHtcbiAgICAgIHRoaXMuX3NvY2tldC5vbmNsb3NlID0gKCkgPT4ge1xuICAgICAgICAvLyBlbXB0eVxuICAgICAgfTtcbiAgICAgIHRoaXMuX3NvY2tldC5jbG9zZSgpO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIF9zb2NrZXRTZW5kID0gKHNvY2tldE1lc3NhZ2U6IElTb2NrZXRNZXNzYWdlKSA9PiB7XG4gICAgY29uc3QgbWVzc2FnZTogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoc29ja2V0TWVzc2FnZSk7XG5cbiAgICBpZiAodGhpcy5fc29ja2V0ICYmIHRoaXMuX3NvY2tldC5yZWFkeVN0YXRlID09PSAxKSB7XG4gICAgICB0aGlzLl9zb2NrZXQuc2VuZChtZXNzYWdlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fc2V0VG9RdWV1ZShzb2NrZXRNZXNzYWdlKTtcbiAgICAgIHRoaXMuX3NvY2tldENyZWF0ZSgpO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIF9zb2NrZXRSZWNlaXZlID0gYXN5bmMgKGV2ZW50OiBNZXNzYWdlRXZlbnQpID0+IHtcbiAgICBsZXQgc29ja2V0TWVzc2FnZTogSVNvY2tldE1lc3NhZ2U7XG5cbiAgICB0cnkge1xuICAgICAgc29ja2V0TWVzc2FnZSA9IEpTT04ucGFyc2UoZXZlbnQuZGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLl9zb2NrZXRTZW5kKHtcbiAgICAgIHRvcGljOiBzb2NrZXRNZXNzYWdlLnRvcGljLFxuICAgICAgdHlwZTogJ2FjaycsXG4gICAgICBwYXlsb2FkOiAnJyxcbiAgICAgIHNpbGVudDogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLl9zb2NrZXQgJiYgdGhpcy5fc29ja2V0LnJlYWR5U3RhdGUgPT09IDEpIHtcbiAgICAgIGNvbnN0IGV2ZW50cyA9IHRoaXMuX2V2ZW50cy5maWx0ZXIoXG4gICAgICAgIChpdGVtRXZlbnQpID0+IGl0ZW1FdmVudC5ldmVudCA9PT0gJ21lc3NhZ2UnLFxuICAgICAgKTtcbiAgICAgIGlmIChldmVudHMgJiYgZXZlbnRzLmxlbmd0aCkge1xuICAgICAgICBldmVudHMuZm9yRWFjaCgoaXRlbUV2ZW50KSA9PiBpdGVtRXZlbnQuY2FsbGJhY2soc29ja2V0TWVzc2FnZSkpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIF9zb2NrZXRFcnJvciA9IChlOiBFdmVudCkgPT4ge1xuICAgIGNvbnN0IGV2ZW50cyA9IHRoaXMuX2V2ZW50cy5maWx0ZXIoKGV2ZW50KSA9PiBldmVudC5ldmVudCA9PT0gJ2Vycm9yJyk7XG4gICAgaWYgKGV2ZW50cyAmJiBldmVudHMubGVuZ3RoKSB7XG4gICAgICBldmVudHMuZm9yRWFjaCgoZXZlbnQpID0+IGV2ZW50LmNhbGxiYWNrKGUpKTtcbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBfcXVldWVTdWJzY3JpcHRpb25zID0gKCkgPT4ge1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSB0aGlzLl9zdWJzY3JpcHRpb25zO1xuXG4gICAgc3Vic2NyaXB0aW9ucy5mb3JFYWNoKCh0b3BpYzogc3RyaW5nKSA9PlxuICAgICAgdGhpcy5fcXVldWUucHVzaCh7XG4gICAgICAgIHRvcGljOiB0b3BpYyxcbiAgICAgICAgdHlwZTogJ3N1YicsXG4gICAgICAgIHBheWxvYWQ6ICcnLFxuICAgICAgICBzaWxlbnQ6IHRydWUsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IHRoaXMub3B0cy5zdWJzY3JpcHRpb25zIHx8IFtdO1xuICB9O1xuXG4gIHByaXZhdGUgX3NldFRvUXVldWUgPSAoc29ja2V0TWVzc2FnZTogSVNvY2tldE1lc3NhZ2UpID0+IHtcbiAgICB0aGlzLl9xdWV1ZS5wdXNoKHNvY2tldE1lc3NhZ2UpO1xuICB9O1xuXG4gIHByaXZhdGUgX3B1c2hRdWV1ZSA9ICgpID0+IHtcbiAgICBjb25zdCBxdWV1ZSA9IHRoaXMuX3F1ZXVlO1xuXG4gICAgcXVldWUuZm9yRWFjaCgoc29ja2V0TWVzc2FnZTogSVNvY2tldE1lc3NhZ2UpID0+XG4gICAgICB0aGlzLl9zb2NrZXRTZW5kKHNvY2tldE1lc3NhZ2UpLFxuICAgICk7XG5cbiAgICB0aGlzLl9xdWV1ZSA9IFtdO1xuICB9O1xufVxuXG5mdW5jdGlvbiBnZXRXZWJTb2NrZXRVcmwoXG4gIHdlYlVybDogc3RyaW5nLFxuICBwcm90b2NvbDogc3RyaW5nLFxuICB2ZXJzaW9uOiBudW1iZXIsXG4pOiBzdHJpbmcge1xuICBjb25zdCB1cmwgPSB3ZWJVcmwuc3RhcnRzV2l0aCgnaHR0cHMnKVxuICAgID8gd2ViVXJsLnJlcGxhY2UoJ2h0dHBzJywgJ3dzcycpXG4gICAgOiB3ZWJVcmwuc3RhcnRzV2l0aCgnaHR0cCcpXG4gICAgPyB3ZWJVcmwucmVwbGFjZSgnaHR0cCcsICd3cycpXG4gICAgOiB3ZWJVcmw7XG4gIGNvbnN0IHNwbGl0VXJsID0gdXJsLnNwbGl0KCc/Jyk7XG4gIGNvbnN0IHBhcmFtcyA9IGlzQnJvd3NlcigpXG4gICAgPyB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICBlbnY6ICdicm93c2VyJyxcbiAgICAgICAgaG9zdDogZ2V0TG9jYXRpb24oKT8uaG9zdCB8fCAnJyxcbiAgICAgIH1cbiAgICA6IHtcbiAgICAgICAgcHJvdG9jb2wsXG4gICAgICAgIHZlcnNpb24sXG4gICAgICAgIGVudjogZGV0ZWN0RW52KCk/Lm5hbWUgfHwgJycsXG4gICAgICB9O1xuICBjb25zdCBxdWVyeVN0cmluZyA9IGFwcGVuZFRvUXVlcnlTdHJpbmcoXG4gICAgZ2V0UXVlcnlTdHJpbmcoc3BsaXRVcmxbMV0gfHwgJycpLFxuICAgIHBhcmFtcyxcbiAgKTtcbiAgcmV0dXJuIHNwbGl0VXJsWzBdICsgJz8nICsgcXVlcnlTdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IFNvY2tldFRyYW5zcG9ydDtcbiJdfQ==